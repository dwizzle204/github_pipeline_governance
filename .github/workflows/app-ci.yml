name: app-ci-reusable

on:
  workflow_call:
    inputs:
      app_dir:
        required: false
        type: string
        default: src/function_app
      tests_dir:
        required: false
        type: string
        default: tests
      function_name:
        required: false
        type: string
        default: HttpExample
      python_version:
        required: false
        type: string
        default: "3.11"
      node_version:
        required: false
        type: string
        default: "20"

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Install dependencies
        working-directory: ${{ inputs.app_dir }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install flake8 pytest

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Lint source
        run: |
          flake8 ${{ inputs.app_dir }} --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 ${{ inputs.app_dir }} --count --max-complexity=10 --max-line-length=127 --statistics

      - name: Validate Python compilation
        run: python -m compileall -q ${{ inputs.app_dir }}

      - name: Run unit tests
        run: pytest -q ${{ inputs.tests_dir }}

      - name: Sample local runtime test (Core Tools)
        shell: bash
        run: |
          set -euo pipefail
          cat > "${{ inputs.app_dir }}/local.settings.json" <<'SETTINGS'
          {
            "IsEncrypted": false,
            "Values": {
              "AzureWebJobsStorage": "UseDevelopmentStorage=true",
              "FUNCTIONS_WORKER_RUNTIME": "python"
            }
          }
          SETTINGS

          pushd "${{ inputs.app_dir }}" >/dev/null
          func start --python --port 7071 > "${GITHUB_WORKSPACE}/func.log" 2>&1 &
          FUNC_PID=$!
          trap "kill ${FUNC_PID} >/dev/null 2>&1 || true" EXIT

          READY=0
          for _ in $(seq 1 30); do
            if curl -fsS "http://127.0.0.1:7071/api/${{ inputs.function_name }}?name=CI" > /tmp/function_response.txt; then
              READY=1
              break
            fi
            sleep 2
          done

          if [ "$READY" -ne 1 ]; then
            echo "Function host did not become ready in time."
            cat "${GITHUB_WORKSPACE}/func.log" || true
            exit 1
          fi

          grep -F "Hello, CI." /tmp/function_response.txt
          popd >/dev/null

      - name: Validate package artifact creation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          pushd "${{ inputs.app_dir }}" >/dev/null
          zip -r "${GITHUB_WORKSPACE}/dist/function_app.zip" .
          popd >/dev/null
          test -s "${GITHUB_WORKSPACE}/dist/function_app.zip"
