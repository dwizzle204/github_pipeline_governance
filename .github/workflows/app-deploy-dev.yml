name: app-deploy-dev-reusable

on:
  workflow_call:
    inputs:
      function_app_name_dev:
        required: true
        type: string
      git_ref:
        required: false
        type: string
        default: main
      app_dir:
        required: false
        type: string
        default: src/function_app
      environment_name:
        required: false
        type: string
        default: dev
    secrets:
      azure_client_id_dev_deploy:
        required: true
      azure_tenant_id:
        required: true
      azure_subscription_id:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment_name }}
    steps:
      - name: Checkout selected ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: Resolve package name
        id: package_meta
        uses: actions/github-script@v7
        with:
          script: |
            const shortSha = process.env.GITHUB_SHA.slice(0, 7);
            const packageName = `function_app-dev-${shortSha}.zip`;
            core.setOutput("package_name", packageName);

      - name: Build temporary dev package
        id: package
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          pushd "${{ inputs.app_dir }}" >/dev/null
          zip -r "${GITHUB_WORKSPACE}/dist/${{ steps.package_meta.outputs.package_name }}" .
          popd >/dev/null
          test -s "${GITHUB_WORKSPACE}/dist/${{ steps.package_meta.outputs.package_name }}"
          echo "package_path=${GITHUB_WORKSPACE}/dist/${{ steps.package_meta.outputs.package_name }}" >> "$GITHUB_OUTPUT"

      - name: Azure login (dev deploy identity)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.azure_client_id_dev_deploy }}
          tenant-id: ${{ secrets.azure_tenant_id }}
          subscription-id: ${{ secrets.azure_subscription_id }}

      - name: Deploy package to dedicated dev app
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ inputs.function_app_name_dev }}
          package: ${{ steps.package.outputs.package_path }}

      - name: Logout Azure session
        if: always()
        run: az logout
